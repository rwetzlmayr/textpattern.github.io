var q,jsonFeedUrl="/feeds/feed.json",$searchForm=$("[data-search-form]"),$searchInput=$("[data-search-input]"),$resultTemplate=$("#search-result"),$resultsPlaceholder=$("[data-search-results]"),$foundContainer=$("[data-search-found]"),$foundTerm=$("[data-search-found-term]"),$foundCount=$("[data-search-found-count]"),allowEmpty=true,showLoader=true,loadingClass="is--loading",indexVar;$(document).ready(function(){$foundContainer.hide();initSearch()});function initSearch(){if(!sessionStorage.getItem("lunrIndex")){getData()}else{if(getParameterByName("q")){q=decodeURIComponent(getParameterByName("q"));$searchInput.val(q);execSearch(q)}}$(document).on("submit",$searchForm,function(e){e.preventDefault();q=$searchInput.val();execSearch(q)})}function getData(indexVar){jqxhr=$.getJSON(jsonFeedUrl).done(function(loaded_data){sessionStorage.setItem("actualData",JSON.stringify(loaded_data));indexVar=lunr(function(){this.field("id");this.field("title");this.field("content",{boost:10});this.field("author");loaded_data.forEach(function(doc,index){if(doc.search_omit!="true"){console.log("adding to index: "+doc.title);this.add($.extend({id:index},doc))}},this)});sessionStorage.setItem("lunrIndex",JSON.stringify(indexVar));if(getParameterByName("q")){q=decodeURIComponent(getParameterByName("q"));$searchInput.val(q);execSearch(q)}}).fail(function(){console.log("get json failed...")}).always(function(){console.log("finally...")})}function getResults(q){var savedIndexData=JSON.parse(sessionStorage.getItem("lunrIndex"));console.log("Indexed var from sessionStorage: "+savedIndexData);return lunr.Index.load(savedIndexData).search(q)}function execSearch(q){if(q!=""||allowEmpty){if(showLoader){toggleLoadingClass()}processResultData(getResults(q))}}function toggleLoadingClass(){$resultsPlaceholder.toggleClass(loadingClass);$foundContainer.toggleClass(loadingClass)}function processResultData(searchResults){$results=[];console.log("Search Results: "+searchResults);var resultsCount=0,results="";searchResults.forEach(function(result){var loaded_data=JSON.parse(sessionStorage.getItem("actualData"));var item=loaded_data[result.ref];var result=populateResultContent($resultTemplate.html(),item);resultsCount++;results+=result});if(showLoader){toggleLoadingClass()}populateResultsString(resultsCount);showSearchResults(results)}function showSearchResults(results){$resultsPlaceholder.html(results)}function populateResultContent(html,item){html=injectContent(html,item.title,"##Title##");html=injectContent(html,item.link,"##Url##");if(item.excerpt)html=injectContent(html,item.excerpt,"##Excerpt##");else html=injectContent(html,"","##Excerpt##");if(item.date)html=injectContent(html,item.date,"##Date##");else html=injectContent(html,"","##Date##");return html}function populateResultsString(count){$foundTerm.text(q);$foundCount.text(count);$foundContainer.show()}function getParameterByName(name){var match=RegExp("[?&]"+name+"=([^&]*)").exec(window.location.search);return match&&decodeURIComponent(match[1].replace(/\+/g," "))}function injectContent(originalContent,injection,placeholder){var regex=new RegExp(placeholder,"g");return originalContent.replace(regex,injection)}
